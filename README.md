# Plasmid Manager Development Log

## Settings Page Internationalization and Export Optimization (2026-02-07)
- **Full Translation of Settings Page**:
    - Fixed multiple hardcoded Chinese texts in the settings modal, achieving complete internationalization binding.
    - Covered translation for 12+ UI elements including "Default Owner", "Items per Page", "Sort Order", "Empty State Prompt", and search box placeholders.
    - Optimized the display logic of pagination controls to support grammatical differences between Chinese and English (e.g., "第 X 到 Y 条" vs. "Showing X to Y").
- **Enhanced Operation Feedback**:
    - Added Toast real-time feedback for the "Save" button on the settings page, ensuring users receive clear visual confirmation after saving configurations.
- **Data Export Optimization**:
    - Resolved the issue where "Project" and "Owner" only displayed ID numbers during CSV export.
    - Enhanced the `downloadCSV` function to automatically convert IDs to names, ensuring exported data is readable for sharing and review.
- **Involved Files**: `index.html`, `js/app.js`, `js/translations_data.js`, `js/data-service.js`.

## Smart Recognition Enhancement and macOS Build Optimization (2026-02-07)
- **"New Plasmid" Smart Recognition Enhancement**:
    - Upgraded the smart recognition UI during single plasmid creation to an **optional checkbox preview** mode, consistent with batch import.
    - Added the ability to **manually add (+) recognition items**, supporting quick attribute expansion during single creation.
    - Introduced an **auto-recognition switch**, allowing users to control whether smart parsing is triggered when entering names.
    - Implemented state synchronization: checking a preview item automatically updates the main form fields in real-time.
- **macOS Build Compatibility Fix**:
    - Increased the icon size generated by `convert-icon.js` to `1024x1024`, resolving the minimum 512x512 icon requirement for macOS packaging.
- **Internationalization and Garbled Text Fix**:
    - Completely resolved potential garbled text issues for `gen_1611` (Open Software) and `gen_1612` (View Sequence) buttons in some environments.
    - Ensured text rendering stability by migrating these core button texts to the `common` namespace in i18n and updating references.
    - Improved the general text lookup table in `i18n.js` to support both Chinese and English.
- **Involved Files**: `index.html`, `js/app.js`, `js/i18n.js`, `js/translations_data.js`, `convert-icon.js`.

## Batch Import UI/UX Deep Optimization and Internationalization Improvement (2026-02-07)
- **Input Interaction Upgrade**:
    - All 12 key plasmid attributes (e.g., resistance, tags, promoters) text input fields have been fully upgraded to **selectable lists**.
    - Implemented **dynamic addition of new values**, allowing users to directly input and expand the attribute library on the interface, with automatic deduplication logic.
    - Optimized data saving logic: only selected attribute values from the list are persisted, avoiding interference from invalid data.
- **Batch Import Enhancement**:
    - Modal width adjusted to `98vw`, greatly improving the display of long filenames on the interface, supporting automatic line wrapping.
    - Fixed `t is not defined` runtime error, ensuring the translation function is available in all logic modules.
    - Implemented **cross-validation recognition** between filenames and file content (GenBank features), significantly improving auto-fill accuracy.
- **Internationalization (i18n) Completeness**:
    - Removed all hardcoded Chinese guide content from `app.js`, unifying it through the i18n translation engine.
    - Improved the Chinese-English lookup table in `translations_data.js`, fixing redundant symbols and formatting errors in some texts.
    - Explicitly set HTML script loading encoding to `UTF-8`, resolving potential title garbled text issues in Windows desktop environments.
- **Engineering and Distribution**:
    - Configured GitHub Actions workflow, enabling automated cross-platform build and release processes triggered by code tags.
    - Added permission management configuration (`entitlements`) for macOS to ensure file access and runtime compatibility on macOS.
- **Involved Files**: `index.html`, `js/app.js`, `js/batch-logic.js`, `js/recognition.js`, `js/translations_data.js`, `package.json`, `.github/workflows/release.yml`.

## UniProt Deep Integration: Species Filtering and Data Enhancement
- **New Capabilities**:
  - Referenced Chrome extension logic to support precise species filtering by Taxonomy ID (based on plasmid "Species" field).
  - Implemented a search strategy prioritizing Reviewed (manually curated) entries, falling back to Unreviewed, to improve result relevance.
  - Added extraction of extended information such as Subcellular Location, RefSeq ID, and STRING ID.
- **Scope of Impact**:
  - `js/services/uniprotService.js` (core search logic refactoring, field parsing enhancement)
  - `js/app.js` (species ID mapping and passing)
  - `index.html` (modal UI update, displaying extended information)

## Fixes and Optimizations (2026-02-06)
- **Fix**: Resolved `plasmid.物种.trim is not a function` runtime error, enhancing compatibility with non-string (e.g., array) species fields.
- **Optimization**: Corrected HTML validation errors in `index.html` (including missing button types, improper tag nesting, unescaped characters), improving code quality and accessibility.
- **Feature Enhancement**: Optimized the display specifications for UniProt function descriptions.
  - Supported displaying multiple function descriptions as a list (originally only the first was shown).
  - Automatically parsed and linked literature references (e.g., `(PubMed:123456)` converted to clickable links).
  - Added FlyBase ID extraction and display (supporting clickable links to FlyBase report pages).
  - Involved Files: `js/services/uniprotService.js`, `index.html`, `package.json`.

## Packaging and Path Security Optimization (2026-02-06)
- **Core Fix**: Resolved the issue where the packaged `.exe` could not be opened (silent crash).
- **Path Redirection**:
  - Redirected storage paths for databases, settings, and logs from `__dirname` (installation directory, usually read-only and permission-restricted) to `app.getPath('userData')` (user data directory).
  - Ensured the program can perform file read/write operations normally after being packaged as ASAR.
- **Automatic Migration Mechanism**:
  - Implemented database migration logic from the installation directory to the user data directory, ensuring data is not lost when users update versions.
- **Packaging Enhancement**:
  - Introduced the `sharp` library to replace `svg2png`, resolving compatibility errors during icon conversion in Windows environments.
  - Prioritized the use of generated `icon.png` in `main.js` to improve the success rate of window icon loading.
- **Involved Files**: `main.js`, `package.json`, `convert-icon.js`.
- **Custom Icon (v4 Design - Final Visual Enhancement)**:
  - The icon was redrawn for the fourth time based on user-provided reference images, achieving high visual fidelity.
  - **Visual Fidelity**: Simulated the thick blue plasmid broken ring, intertwined DNA double helix path, and "electric spark/break" details at the top from the reference image.
  - **Packaging Compatibility Optimization (2026-02-06)**:
    - Simplified the `icon.svg` structure to address `electron-builder`'s SVG conversion errors (`ERR_ELECTRON_BUILDER_CANNOT_EXECUTE`) on Windows.
    - Removed `filter` effects and complex `tspan` nesting that caused conversion crashes, using flattened paths to achieve visual effects.
    - Optimized the `package.json`'s `build` configuration, precisely limiting icon declarations to the `win` platform section to reduce build interference.
- **Application Integration**:
  - `main.js`: Set Electron window icon to ensure the icon is displayed in the desktop taskbar and window title bar.
  - `index.html`: Added Favicon link to improve visual consistency of the application in different environments.
  - `package.json`: Updated packaging configuration to apply the new icon to generated `.exe` installers and portable versions.
- **Involved Files**: `assets/icon.svg`, `main.js`, `index.html`, `package.json`.

---

# 质粒管理系统开发日志

## 设置页国际化与导出优化 (2026-02-07)
- **设置页面全翻译**:
    - 修复了设置模态框中多处硬编码的中文文本，实现了完整的国际化绑定。
    - 涵盖了“默认持有人”、“分页条数”、“排序顺序”、“空状态提示”以及搜索框占位符等 12+ 处 UI 元素的翻译。
    - 优化了分页控件的显示逻辑，支持中英文语法差异（如“第 X 到 Y 条”与 "Showing X to Y"）。
- **操作反馈增强**:
    - 为设置页面的“保存”按钮添加了 Toast 实时反馈，确保用户在保存配置后能获得明确的视觉确认。
- **数据导出优化**:
    - 解决了 CSV 导出时“项目”和“持有人”仅显示 ID 编号的问题。
    - 增强了 `downloadCSV` 函数，实现了从 ID 到名称的自动转换，确保导出的数据在共享和查阅时具备可读性。
- **涉及文件**: `index.html`, `js/app.js`, `js/translations_data.js`, `js/data-service.js`。

## 智能识别增强与 macOS 构建优化 (2026-02-07)
- **"新建质粒" 智能识别增强**:
    - 将单条质粒创建过程中的智能识别 UI 升级为与批量导入一致的**可选框预览**模式。
    - 增加了**手动添加 (+) 识别项**的功能，支持在单条创建时快速扩展属性。
    - 引入了**自动识别开关**，允许用户自主控制是否在输入名称时触发智能解析。
    - 实现了状态同步：勾选预览项后自动实时更新主表单字段。
- **macOS 构建兼容性修复**:
    - 将 `convert-icon.js` 生成的图标尺寸提升至 `1024x1024`，解决了 macOS 打包要求的最低 512x512 图标限制。
- **国际化与乱码修复**:
    - 彻底解决了 `gen_1611` (软件打开) 和 `gen_1612` (查看序列) 按钮在某些环境下可能出现的乱码问题。
    - 通过将这些核心按钮文本迁移到 i18n 的 `common` 命名空间并更新引用，确保了文本渲染的稳定性。
    - 完善了 `i18n.js` 中的通用文本对照表，支持中英文双语。
- **涉及文件**: `index.html`, `js/app.js`, `js/i18n.js`, `js/translations_data.js`, `convert-icon.js`。

## 批量导入 UI/UX 深度优化与国际化完善 (2026-02-07)
- **输入交互升级**:
    - 将 12 个关键质粒属性（如抗性、标签、启动子等）的文本输入框全面升级为**可勾选列表**。
    - 实现了**动态添加新值**功能，支持用户在界面上直接输入并扩展属性库，且具备自动去重逻辑。
    - 优化了数据保存逻辑：仅保留用户在列表中勾选的属性值进行持久化，避免无效数据干扰。
- **批量导入增强**:
    - 模态框宽度调整为 `98vw`，极大提升了长文件名在界面上的展示效果，支持自动换行。
    - 修复了 `t is not defined` 运行时错误，确保翻译函数在所有逻辑模块中均可用。
    - 实现了文件名与文件内容（GenBank 特征）的**交叉验证识别**，大幅提升了自动填充的准确性。
- **国际化 (i18n) 完整性**:
    - 移除了 `app.js` 中所有硬编码的中文引导内容，统一通过 i18n 翻译引擎驱动。
    - 完善了 `translations_data.js` 的中英文对照表，修复了部分文本中的冗余符号和格式错误。
    - 显式设置 HTML 脚本加载编码为 `UTF-8`，解决了 Windows 桌面版环境下可能出现的标题乱码问题。
- **工程化与分发**:
    - 配置了 GitHub Actions 工作流，实现了基于代码标签（Tag）触发的自动化跨平台构建发布流程。
    - 针对 macOS 增加了权限管理配置 (`entitlements`)，确保在 macOS 下的文件访问与运行兼容性。
- **涉及文件**: `index.html`, `js/app.js`, `js/batch-logic.js`, `js/recognition.js`, `js/translations_data.js`, `package.json`, `.github/workflows/release.yml`。

## UniProt 深度集成：物种过滤与数据增强
- **新增能力**:
  - 参考 Chrome 扩展逻辑，支持 Taxonomy ID 精确物种过滤（基于质粒“物种”字段）。
  - 实现 Reviewed (人工审阅) 优先、Unreviewed 兜底的搜索策略，提升结果相关性。
  - 新增提取细胞定位 (Subcellular Location)、RefSeq ID、STRING ID 等扩展信息。
- **影响范围**:
  - `js/services/uniprotService.js`（核心搜索逻辑重构、字段解析增强）
  - `js/app.js`（物种 ID 映射与传递）
  - `index.html`（模态框 UI 更新，展示扩展信息）

## 修复与优化 (2026-02-06)
- **修复**: 解决了 `plasmid.物种.trim is not a function` 运行时错误，增强了对非字符串（如数组）物种字段的兼容性。
- **优化**: 修正了 `index.html` 中的 HTML 验证错误（包括按钮类型缺失、标签嵌套不规范、未转义字符等），提升了代码质量和可访问性。
- **功能增强**: 优化了 UniProt 功能描述的显示规范。
  - 支持多条功能描述按列表显示（原为仅显示第一条）。
  - 自动解析并链接文献引用（如 `(PubMed:123456)` 转换为可点击链接）。
  - 新增 FlyBase ID 提取与显示（支持点击跳转到 FlyBase 报告页）。
  - 涉及文件: `js/services/uniprotService.js`, `index.html`, `package.json`。

## 打包运行与路径安全优化 (2026-02-06)
- **核心修复**: 解决了打包后的 `.exe` 无法打开（静默崩溃）的问题。
- **路径重定向**:
  - 将数据库、设置和日志的存储路径从 `__dirname`（安装目录，通常只读且权限受限）重定向到 `app.getPath('userData')`（用户数据目录）。
  - 确保了程序在打包成 ASAR 后仍能正常进行文件读写操作。
- **自动迁移机制**:
  - 实现了从安装目录到用户数据目录的数据库迁移逻辑，确保用户更新版本后数据不丢失。
- **打包增强**:
  - 引入了 `sharp` 库替代 `svg2png`，解决了 Windows 环境下图标转换的兼容性报错。
  - 在 `main.js` 中优先使用生成的 `icon.png` 提升窗口图标加载的成功率。
- **涉及文件**: `main.js`, `package.json`, `convert-icon.js`。
- **自定义图标 (v4 设计 - 最终视觉增强)**:
  - The icon was redrawn for the fourth time based on user-provided reference images, achieving high visual fidelity.
  - **Visual Fidelity**: Simulated the thick blue plasmid broken ring, intertwined DNA double helix path, and "electric spark/break" details at the top from the reference image.
  - **Packaging Compatibility Optimization (2026-02-06)**:
    - Simplified the `icon.svg` structure to address `electron-builder`'s SVG conversion errors (`ERR_ELECTRON_BUILDER_CANNOT_EXECUTE`) on Windows.
    - Removed `filter` effects and complex `tspan` nesting that caused conversion crashes, using flattened paths to achieve visual effects.
    - Optimized the `package.json`'s `build` configuration, precisely limiting icon declarations to the `win` platform section to reduce build interference.
- **Application Integration**:
  - `main.js`: Set Electron window icon to ensure the icon is displayed in the desktop taskbar and window title bar.
  - `index.html`: Added Favicon link to improve visual consistency of the application in different environments.
  - `package.json`: Updated packaging configuration to apply the new icon to generated `.exe` installers and portable versions.
- **Involved Files**: `assets/icon.svg`, `main.js`, `index.html`, `package.json`.
