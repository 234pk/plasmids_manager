# 智能下拉框设计方案

> 创建时间：2026-02-04

## 需求分析

### 核心功能
1. **内置预设值** - 常见选项预定义在代码中
2. **自动学习** - 用户填写新值后，自动添加到下拉框
3. **数据持久化** - 用户添加的新值保存到 localStorage

### 数据来源
1. **预设值** - 代码内置的常见选项
2. **数据库提取** - 从 `plasmid_database.json` 中提取已有值
3. **用户自定义** - 用户手动输入并保存的新值

---

## 数据结构设计

### 1. 内置预设值

```javascript
// presets.js
const PRESETS = {
    载体类型: ['pLKO', 'pCDH', 'pcDNA3.1', 'pUAST', 'pAc5', '慢病毒包装', 'pmBaoJin', 'pGL3', 'pLVX', 'pMD2', 'psPAX2'],
    功能: ['空载体', 'RNAi敲降', 'CRISPR敲除', '过表达-蛋白', '过表达-miRNA'],
    蛋白标签: ['3×FLAG', '3×HA', '6×His', 'Myc', 'GFP', 'EGFP', 'V5', 'FLAG', '无'],
    哺乳动物抗性: ['NeoR', 'Puromycin', 'Hygromycin'],
    大肠杆菌抗性: ['AmpR', 'KanR'],
    启动子: ['CMV', 'EF1α', 'UAS', 'hsp70', 'TRE', 'SV40', 'miniP'],
    插入类型: ['shRNA', 'sgRNA', 'cDNA', 'ORF'],
    物种: ['哺乳动物', 'Drosophila', 'Bacterial', 'Yeast'],
    CRISPR类型: ['CRISPR-KO', 'CRISPRi', 'CRISPRa'],
    四环素诱导: ['Tet-On', 'Tet-Off', 'rtTA'],
    荧光蛋白: ['GFP', 'EGFP', 'mCherry', 'RFP', 'YFP']
};
```

### 2. 用户自定义值存储结构

```javascript
// localStorage 存储格式
{
    "custom_载体类型": ["pHA-Myc", "pHis"],
    "custom_靶基因": ["TIA1", "BACC", "NEW-GENE"],
    "custom_蛋白标签": ["自定义标签1"]
}
```

---

## 核心函数实现

### 1. 获取某字段的所有选项（合并来源）

```javascript
// smartDropdown.js

// 从数据库提取某字段的唯一值
function extractFromData(field) {
    const values = new Set();
    plasmids.forEach(p => {
        const val = p[field];
        if (Array.isArray(val)) {
            val.forEach(v => values.add(v));
        } else if (val) {
            values.add(val);
        }
    });
    return Array.from(values).sort();
}

// 从 localStorage 获取用户自定义值
function getUserCustom(field) {
    try {
        const saved = localStorage.getItem(`custom_${field}`);
        return saved ? JSON.parse(saved) : [];
    } catch (e) {
        return [];
    }
}

// 保存用户自定义值
function addUserCustom(field, value) {
    const values = getUserCustom(field);
    if (!values.includes(value)) {
        values.push(value);
        localStorage.setItem(`custom_${field}`, JSON.stringify(values));
        return true; // 表示新增了
    }
    return false; // 已存在
}

// 合并所有来源获取最终选项列表
function getAllOptions(field) {
    const presets = PRESETS[field] || [];
    const dataVals = extractFromData(field);
    const userVals = getUserCustom(field);
    
    // 合并去重，优先级：用户自定义 > 数据库提取 > 预设值
    const all = [...new Set([...presets, ...dataVals, ...userVals])];
    return all.sort();
}
```

### 2. Vue 3 组件实现（Element Plus）

```vue
<!-- SmartSelect.vue -->
<template>
  <el-select
    v-model="selectedValues"
    multiple
    filterable
    allow-create
    default-first-option
    :reserve-keyword="false"
    placeholder="选择或输入新值"
    @change="onChange"
    @visible-change="onVisibleChange"
  >
    <el-option-group label="预设值">
      <el-option
        v-for="opt in presetOptions"
        :key="opt"
        :label="opt"
        :value="opt"
      />
    </el-option-group>
    
    <el-option-group v-if="userOptions.length > 0" label="历史记录">
      <el-option
        v-for="opt in userOptions"
        :key="opt"
        :label="opt"
        :value="opt"
      />
    </el-option-group>
    
    <el-option-group v-if="dataOptions.length > 0" label="数据库已有">
      <el-option
        v-for="opt in dataOptions"
        :key="opt"
        :label="opt"
        :value="opt"
      />
    </el-option-group>
  </el-select>
</template>

<script setup>
import { ref, computed, watch } from 'vue';

const props = defineProps({
  modelValue: { type: Array, default: () => [] },
  field: { type: String, required: true }  // 如 '载体类型', '蛋白标签'
});

const emit = defineEmits(['update:modelValue']);

const selectedValues = ref(props.modelValue);

// 获取各类选项
const presetOptions = computed(() => PRESETS[props.field] || []);
const dataOptions = computed(() => extractFromData(props.field));
const userOptions = computed(() => getUserCustom(props.field));

// 监听父组件传入的值
watch(() => props.modelValue, (val) => {
  selectedValues.value = val;
});

// 值变化时保存用户自定义值
function onChange(values) {
  // 检查是否有新值需要保存
  values.forEach(val => {
    if (!presetOptions.value.includes(val)) {
      addUserCustom(props.field, val);
    }
  });
  emit('update:modelValue', values);
}

function onVisibleChange(show) {
  if (!show) {
    // 关闭时刷新选项列表
  }
}
</script>
```

### 3. 纯 HTML/JS 实现（不用 Vue 组件）

```html
<!-- 简单下拉框实现 -->
<style>
.smart-select {
  position: relative;
  width: 200px;
}
.smart-select input {
  width: 100%;
  padding: 8px;
  border: 1px solid #ddd;
  border-radius: 4px;
}
.smart-select .dropdown {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: white;
  border: 1px solid #ddd;
  max-height: 200px;
  overflow-y: auto;
  z-index: 1000;
  display: none;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}
.smart-select .dropdown.show {
  display: block;
}
.smart-select .dropdown-group {
  padding: 8px;
}
.smart-select .dropdown-group-title {
  font-size: 10px;
  color: #888;
  text-transform: uppercase;
  padding: 4px 8px;
  background: #f5f5f5;
}
.smart-select .dropdown-item {
  padding: 6px 12px;
  cursor: pointer;
}
.smart-select .dropdown-item:hover {
  background: #e3f2fd;
}
</style>

<div class="smart-select">
  <input 
    type="text" 
    placeholder="选择或输入..." 
    onfocus="showDropdown(this)"
    oninput="filterOptions(this)"
    onkeydown="handleKeydown(this, event)"
  >
  <div class="dropdown"></div>
</div>

<script>
function showDropdown(input) {
  const field = input.dataset.field;
  const allOptions = getAllOptions(field);
  const recentOptions = getUserCustom(field).slice(-10);  // 最近使用的10个
  
  const html = `
    <div class="dropdown-group">
      <div class="dropdown-group-title">预设值</div>
      ${PRESETS[field]?.map(opt => 
        `<div class="dropdown-item" onclick="selectOption(this, '${opt}')">${opt}</div>`
      ).join('')}
    </div>
    ${recentOptions.length > 0 ? `
    <div class="dropdown-group">
      <div class="dropdown-group-title">最近使用</div>
      ${recentOptions.map(opt => 
        `<div class="dropdown-item" onclick="selectOption(this, '${opt}')">${opt}</div>`
      ).join('')}
    </div>
    ` : ''}
  `;
  
  input.nextElementSibling.innerHTML = html;
  input.nextElementSibling.classList.add('show');
}

function filterOptions(input) {
  const keyword = input.value.toLowerCase();
  const items = input.nextElementSibling.querySelectorAll('.dropdown-item');
  items.forEach(item => {
    const show = item.textContent.toLowerCase().includes(keyword);
    item.style.display = show ? 'block' : 'none';
  });
}

function selectOption(input, value) {
  input.closest('.smart-select').querySelector('input').value = value;
  input.closest('.dropdown').classList.remove('show');
  
  // 保存到用户自定义
  const field = input.closest('.smart-select').querySelector('input').dataset.field;
  addUserCustom(field, value);
}

function handleKeydown(input, event) {
  if (event.key === 'Enter') {
    const value = input.value.trim();
    if (value) {
      const field = input.dataset.field;
      addUserCustom(field, value);
      selectOption(input, value);
    }
  }
}
</script>
```

---

## 实现优先级

| 功能 | 优先级 | 难度 |
|------|--------|------|
| 内置预设值显示 | P0 | 低 |
| 数据库已有值提取 | P0 | 低 |
| 用户输入新值保存 | P1 | 中 |
| localStorage 持久化 | P1 | 低 |
| 最近使用排序 | P2 | 中 |
| 最常用排序 | P2 | 中 |
| 多选支持 | P1 | 中 |

---

## 下一步

1. 在 `js/` 目录下创建 `smartDropdown.js`
2. 修改编辑弹窗中的 `<el-select>` 为智能下拉框
3. 测试数据提取和用户保存功能
