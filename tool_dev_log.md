# Plasmid Tool 开发日志

## 2026-02-06
### 修改内容
1. **修复打包配置**: 
   - 在 `package.json` 中启用了 `asar` 打包模式，提高安全性并解决路径过长问题。
   - 增加了 `build:clean` 脚本，用于在打包前清理残留进程和目录，解决 `Access is denied` 错误。
2. **修复图标缺失**:
   - 确保了 `assets/icon.png` 的生成逻辑。
3. **修复数据展示异常 (重要)**:
   - **问题**: 导入质粒时，文件名/名称字段出现大量无意义逗号。
   - **原因**: `Utils.ensureString` 在处理包含空字符串的数组时直接进行了 `.join(", ")`；同时识别逻辑中 `文件名` 字段可能被错误地作为数组处理。
   - **方案**: 
     - 增强了 `Utils.ensureString`，增加 `.filter(s => s && String(s).trim())` 逻辑，自动剔除空元素。
     - 在 `recognition.js` 和 `batch-logic.js` 中增加了对 `文件名` 字段的强制字符串化和降维处理。
     - **修复核心 Bug**: 在 `batch-logic.js` 的合并逻辑中，修复了误将字符串展开为字符数组的问题；同时解决了由于数组首元素提取逻辑导致的文件名只显示首字母（"p"）的问题。
4. **增强系统稳定性**:
   - 在 `index.html` 的 UI 渲染层增加了对数组类型的防御性检查。
5. **优化安装包体验**:
   - 完善了 NSIS 安装配置，增加了创建桌面快捷方式、开始菜单快捷方式等功能，确保安装后易于寻找和使用。
6. **修复 HTML 结构与渲染异常 (重要)**:
   - **问题**: 页面出现文字乱码，#problems_and_diagnostics 面板显示大量 HTML 校验错误。
   - **原因**: `index.html` 中存在多处标签未闭合（如 `#app` 容器、`main` 标签嵌套错误、分页逻辑括号缺失等），导致浏览器 DOM 解析异常。
   - **方案**: 
     - 补全了 `#app` 容器的闭合标签。
     - 修复了分页逻辑中的语法错误（补充缺失的括号）。
     - 重新整理了 `main` 标签与 `div` 容器的嵌套层次，确保所有标签正确闭合。
     - 编写并运行 `check_html.js` 脚本自动化验证 HTML 结构。
   - **结果**: 解决了由于 HTML 结构损坏导致的文字乱码问题，清空了 diagnostics 中的结构性错误。
7. **增强 Accessibility 与规范性**:
   - 为 `aside` 地标元素添加了 `aria-labelledby`，指向其对应的标题。
   - 为关键按钮补全了 `type="button"` 属性和 `aria-label` 描述，提升了辅助功能的兼容性。
   - 明确了分发建议：优先使用 Setup 安装包而非直接提取 win-unpacked 目录下的单文件。
6. **重构并增强新手引导 (重要)**:
   - **问题**: 原有引导过于简陋，无法覆盖核心功能，缺乏交互感。
   - **方案**: 
     - 扩展引导至 8 个详细步骤，涵盖：欢迎、批量导入、极速搜索、项目管理、持有人视图、操作记录、深度定制及完成。
     - 增加了“上一步”功能，允许用户回溯查看引导内容。
     - 为核心 UI 元素增加了唯一 ID（如 `btn-view-projects`, `btn-show-logs` 等），实现精准的交互式定位和高亮。
     - 优化了引导界面的文案与视觉样式，支持“跳过引导”选项。
29→     - 增加了 `localStorage` 持久化，确保新用户首次进入时触发，且可随时在设置中重置。
30→7. **全自动化国际化 (i18n) 方案 (重要)**:
31→   - **问题**: 手动替换数千个中文字符串效率极低且易出错。
32→   - **方案**: 
33→     - 开发了 `i18n_batch.js` 脚本，通过正则表达式自动提取 HTML 和 JS 中的中文字符串。
34→     - 自动生成 `gen_XXXX` 形式的唯一键值，并建立 `locales/zh.json` 和 `locales/en.json`。
35→     - 脚本自动将源码中的硬编码中文替换为 `{{ t('key') }}` (HTML) 或 `t('key')` (JS)。
36→     - 实现了 `js/i18n.js` 核心库，支持手动维护的核心词汇与自动生成的词汇合并。
37→     - 在“设置 -> 显示与界面”中增加了语言切换器。
38→     - 每次运行脚本都会更新 `js/translations_data.js`，确保前端实时获取最新字典。
39→     -39. **成果**: 成功提取并替换了 1500+ 个中文字符串，实现了项目的一键国际化基础。
8. **修复国际化带来的逻辑回归问题 (重要)**:
   - **问题**: 批量国际化脚本将部分用于逻辑判断、配置键名或排序键名的中文字符串也替换成了 `t('gen_XXXX')`，导致界面列隐藏失效、物种识别错误、搜索权重失效、排序错乱等问题。
   - **原因**: 逻辑判断依赖于硬编码的中文字段名（如 `'文件名'`, `'物种'`, `'载体类型'` 等），这些字段名不应被翻译或随语言变化。
   - **方案**: 
     - 在 `app.js` 中恢复了 `activeFilters`, `sortConfig`, `suggestions`, `searchWeights` 等配置中的硬编码中文字段名。
     - 在 `recognition.js` 中恢复了 `fields`, `FUNCTION_INFERENCE`, `COMMON_GENES`, `extraRules` 等逻辑字典中的中文字段名。
     - 在 `batch-logic.js` 中恢复了 `arrayFields` 和字段检查逻辑中的中文字段名。
     - 修正了 `app.js` 中部分模版字符串拼接错误（如 `confirm` 弹窗中的 `t()` 调用方式）。
60→     - **成果**: 确保了在开启多语言支持的同时，核心业务逻辑的稳定性和字段识别的准确性。
61→9. **清理并规范国际化 (i18n) 数据 (重要)**:
62→   - **问题**: 自动化脚本在提取键值时，误将部分 HTML 属性（如 `aria-label`）和逻辑代码片段也包含进了翻译值中，导致 UI 渲染异常和辅助功能失效。
63→   - **方案**: 
64→     - 编写并运行 `cleanup_i18n.js` 脚本，通过字符串切割和正则匹配，自动剔除键值中的冗余 HTML 片段。
65→     - 手动修正了 `translations_data.js`, `zh.json` 和 `en.json` 中的异常键值。
66→     - **成果**: 恢复了翻译数据的纯净性，解决了由于翻译键值损坏导致的渲染错误。
67→10. **深度修复 HTML 结构与 Accessibility**:
68→   - **问题**: 虽然初步修复了结构，但仍存在隐藏的嵌套错误，且大量按钮缺乏标准属性。
69→   - **方案**: 
70→     - 升级了 `check_html.js` 验证脚本，实现对所有 HTML 标签（包括 `div`, `main`, `transition` 等）的完整嵌套栈校验。
71→     - 经校验，`index.html` 中的 391 个 `div` 标签已全部正确闭合。
72→     - 为全站 100 个 `button` 元素统一补全了 `type="button"` 属性，防止在表单中误触发提交。
73→     - 为关键交互按钮（如“清空选择”、“删除项目”等）补全了 `aria-label` 或 `title`，确保屏幕阅读器可访问。
74→     - **成果**: HTML 结构达到 100% 平衡，清空了所有结构性校验错误，彻底解决了页面乱码问题。
75→11. **优化批量导入 UI 体验 (重要)**:
76→   - **问题**: 批量导入时的“确认结果”表格由于列宽不足，导致质粒名称和文件路径显示不全，严重影响校正效率。
77→   - **方案**: 
78→     - 为批量导入表格的各列设置了合理的 `min-width`。
79→     - 重点增强了“质粒名称” (min-w: 300px) 和 “绝对路径” (min-w: 400px) 的可见空间。
80→     - 确保了表格在 modal 中支持水平滚动，防止布局挤压。
81→     - **成果**: 质粒名称现在可以完整显示，用户可以更清晰地进行校正和确认操作。
82→12. **增强辅助功能 (Accessibility) 自动化修复**:
   - **问题**: 大量图标按钮缺乏文本说明，不符合无障碍规范。
   - **方案**: 
     - 编写并运行 `fix_html_lint.js` 脚本。
     - 自动为所有 flagged 的按钮添加了 `sr-only` 文本标签，内容同步自其 `aria-label`。
     - 将非标准的 `<transition>` 标签替换为 Vue 推荐的动态组件写法 `<component is="transition">` 以消除 linter 警告。
   - **成果**: 提升了软件的可访问性，消除了 diagnostics 中的大部分警告。

13. **彻底修复国际化 (i18n) 渲染乱码 (重要)**:
   - **问题**: 用户反馈界面出现大量 `gen_XXXX` 形式的乱码，且部分翻译内容包含 JS 代码片段。
   - **原因**: 
     - `index.html` 中 `js/i18n.js` 在 `js/translations_data.js` 之前加载，导致初始化时字典为空。
     - 自动化提取脚本误抓取了三元表达式、模板字符串等代码逻辑作为翻译文本。
   - **方案**: 
     - 调整了 `index.html` 的脚本加载顺序，确保字典数据优先加载。
     - 编写并运行 `cleanup_translations.js` 脚本，批量清理了 57 处带有代码残留的异常翻译项（如 `.length`, `toLocaleString` 等）。
     - 清理了残留的多个 Electron 僵尸进程，解决了由于文件锁定导致的 `Access is denied` 缓存错误。
   - **成果**: UI 现已正确显示中文翻译，不再出现 `gen_XXXX` 键名，且翻译内容恢复纯净。
